name: ğŸš€ ê°„ë‹¨í•œ ë°°í¬

on:
  push:
    branches: main
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  deploy:
    name: ë¹Œë“œ ë° ë°°í¬
    runs-on: ubuntu-latest
    steps:
      - name: 1. ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: 2. pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: 3. Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: 4. ì˜ì¡´ì„± ì„¤ì¹˜ ë° nginx.conf ìƒì„±
        run: |
          pnpm install --frozen-lockfile
          pnpm generate

          if [ ! -f "nginx.conf" ]; then
            echo "âŒ nginx.conf íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            exit 1
          fi
          echo "âœ… nginx.conf íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."

      - name: 5. GHCR ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 5.1 Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      - name: 6. ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‰¬
        uses: docker/build-push-action@v6
        id: build
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:${{ github.sha }}
            ghcr.io/${{ github.repository }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: 6.1 ë³€ìˆ˜ ì„¤ì •
        run: |
          echo "IMAGE_NAME=ghcr.io/${{ github.repository }}:latest" >> $GITHUB_ENV
          echo "CONTAINER_NAME=nginx-redirect" >> $GITHUB_ENV
          echo "NETWORK_NAME=nginx-proxy-manager_default" >> $GITHUB_ENV

      - name: 7. ì„œë²„ ë°°í¬
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.ORACLE_SERVER_IP }}
          username: ${{ secrets.ORACLE_SERVER_USERNAME }}
          key: ${{ secrets.ORACLE_SERVER_KEY }}
          script: |
            set -e # ì˜¤ë¥˜ ë°œìƒ ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ

            # GHCR ë¡œê·¸ì¸
            echo "âœ… GHCR ë¡œê·¸ì¸"
            echo ${{ secrets.GITHUB_TOKEN }} | sudo docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # ì´ì „ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            echo "âœ… ì´ì „ ì»¨í…Œì´ë„ˆ ì •ë¦¬"
            sudo docker stop ${{ env.CONTAINER_NAME }} || true
            sudo docker rm ${{ env.CONTAINER_NAME }} || true
            sudo docker image prune -f

            # ìƒˆ ì´ë¯¸ì§€ ë°°í¬
            echo "âœ… ìƒˆ ì´ë¯¸ì§€ ë°°í¬"
            sudo docker pull ${{ env.IMAGE_NAME }}
            sudo docker run -d --name ${{ env.CONTAINER_NAME }} --network ${{ env.NETWORK_NAME }} -p 8080:80 ${{ env.IMAGE_NAME }}

            # ë°°í¬ í™•ì¸
            echo "âœ… ë°°í¬ í™•ì¸"
            sleep 3
            sudo docker ps | grep ${{ env.CONTAINER_NAME }}
            sudo docker logs --tail 30 ${{ env.CONTAINER_NAME }} || true

            # ì™„ë£Œ í›„ GHCR ë¡œê·¸ì•„ì›ƒ
            echo "âœ… GHCR ë¡œê·¸ì•„ì›ƒ"
            sudo docker logout ghcr.io
