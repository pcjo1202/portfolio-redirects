name: ğŸš€ ê°„ë‹¨í•œ ë°°í¬

on:
  push:
    branches: main
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  deploy:
    name: ë¹Œë“œ ë° ë°°í¬
    runs-on: ubuntu-latest
    steps:
      - name: 1. ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: 2. pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: 3. Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: 4. ì˜ì¡´ì„± ì„¤ì¹˜ ë° nginx.conf ìƒì„±
        run: |
          pnpm install --frozen-lockfile
          pnpm generate

          if [ ! -f "nginx.conf" ]; then
            echo "âŒ nginx.conf íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            exit 1
          fi
          echo "âœ… nginx.conf íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."

      - name: 5.1 GHCR ë¡œê·¸ì•„ì›ƒ
        run: |
          sudo docker logout ghcr.io

      - name: 5. GHCR ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: 6. ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‰¬
        run: |
          IMAGE_NAME="ghcr.io/${{ github.actor }}/${{ github.repository }}:${{ github.sha }}"
          LATEST_IMAGE="ghcr.io/${{ github.actor }}/${{ github.repository }}:latest"
          sudo docker build -t $IMAGE_NAME .
          sudo docker tag $IMAGE_NAME $LATEST_IMAGE
          sudo docker push $IMAGE_NAME
          sudo docker push $LATEST_IMAGE
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV

      - name: 7. ì„œë²„ ë°°í¬
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.ORACLE_SERVER_IP }}
          username: ${{ secrets.ORACLE_SERVER_USERNAME }}
          key: ${{ secrets.ORACLE_SERVER_KEY }}
          script: |
            # ì´ì „ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            sudo docker stop nginx-redirect || true
            sudo docker rm nginx-redirect || true
            sudo docker image prune -f

            # ìƒˆ ì´ë¯¸ì§€ ë°°í¬
            sudo docker pull ${{ env.IMAGE_NAME }}
            sudo docker run -d --name nginx-redirect -p 8080:80 ${{ env.IMAGE_NAME }}

            # ë°°í¬ í™•ì¸
            sleep 3
            sudo docker ps | grep nginx-redirect
            sudo docker logs --tail 30 nginx-redirect || true
